// Generated by CoffeeScript 1.10.0
var Component, DOM, Directive, Element, ShadowStyle, Tree,
  indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; },
  hasProp = {}.hasOwnProperty,
  slice = [].slice;

Element = require('ui-js/dom/nodes/element');

ShadowStyle = require('./shadow-style');

Directive = require('./directive');

DOM = require('ui-js/dom');

Tree = require('./tree');

module.exports = Component = (function() {
  var compiledComponents, lastId, shadowStyles;

  function Component() {}

  Component.tag = '';

  Component.template = '';

  Component.style = '';

  Component.components = [];

  Component.directives = [];

  Component.tree = null;

  Component.initedComponents = null;

  Component.compiledTemplate = '';

  Component.id = 0;

  lastId = 0;

  compiledComponents = [];

  shadowStyles = new Map();

  Component.create = function(Class) {
    if (indexOf.call(compiledComponents, Class) >= 0) {
      return Class;
    }
    this.extend(Class);
    compiledComponents.push(compiledComponents);
    Class.initedComponents = [];
    Class.isComponent = true;
    Class.id = lastId++;
    Class.compile();
    return Class;
  };

  Component.extend = function(Class) {
    var key, ref, value;
    for (key in this) {
      if (!hasProp.call(this, key)) continue;
      value = this[key];
      if (Class[key] == null) {
        Class[key] = value;
      }
    }
    if (Class.prototype) {
      ref = this.prototype;
      for (key in ref) {
        value = ref[key];
        if (key !== 'constructor') {
          Class.prototype[key] = value;
        }
      }
    }
    return Class;
  };

  Component.compile = function() {
    this.compileComponents();
    this.compileDirectives();
    this.compileTemplate();
    this.compileStyle();
  };

  Component.compileComponents = function() {
    this.components = this.components.map(function(Class) {
      return Component.create(Class);
    });
  };

  Component.compileDirectives = function() {
    this.directives = this.directives.map(function(Class) {
      return Directive.create(Class);
    });
  };

  Component.compileTemplate = function() {
    var templateNode;
    templateNode = DOM.createElement('template');
    templateNode.html(this.template);
    this.tree = new Tree(templateNode, this);
    this.compiledTemplate = this.tree.template;
  };

  Component.compileStyle = function() {
    var components, css, i, len, ref, shadowStyle, styleNode;
    if (!shadowStyles.has(this)) {
      styleNode = document.createElement('style');
      styleNode.setAttribute('shadow-style', this.tag);
      document.head.appendChild(styleNode);
      shadowStyles.set(this, styleNode);
    }
    css = '';
    ref = this._getStyles();
    for (i = 0, len = ref.length; i < len; i++) {
      shadowStyle = ref[i];
      components = slice.call(ui.components).concat(slice.call(this.components));
      css += shadowStyle(this.id, slice.call(ui.components).concat(slice.call(this.components)));
    }
    styleNode = shadowStyles.get(this);
    styleNode.innerHTML = css;
  };

  Component._getStyles = function() {
    var constructor, context, shadowStyle, style, styles;
    styles = [];
    context = this.prototype;
    while (context) {
      constructor = context.constructor;
      if (constructor.hasOwnProperty('style')) {
        style = constructor.style;
        shadowStyle = ShadowStyle.compile(style);
        styles.unshift(shadowStyle);
      }
      context = Object.getPrototypeOf(context);
    }
    return styles;
  };

  Component.getSubComponent = function(node) {
    var component, components, globalComponents, i, len, tag;
    globalComponents = ui.components.filter((function(_this) {
      return function(component) {
        return component !== _this;
      };
    })(this));
    components = globalComponents.concat(this.components);
    for (i = 0, len = components.length; i < len; i++) {
      component = components[i];
      tag = component.tag;
      if (tag === node.tag) {
        return component;
      }
    }
    return null;
  };

  Component.isSubComponent = function(node) {
    return !!this.getSubComponent(node);
  };

  Component.getDirective = function(name) {
    var Dir, i, j, len, len1, ref, ref1;
    ref = this.directives;
    for (i = 0, len = ref.length; i < len; i++) {
      Dir = ref[i];
      if (Dir.attribute === name) {
        return Dir;
      }
    }
    ref1 = ui.directives;
    for (j = 0, len1 = ref1.length; j < len1; j++) {
      Dir = ref1[j];
      if (Dir.attribute === name) {
        return Dir;
      }
    }
    return null;
  };

  Component.find = function(node, shadowPrefix) {
    var tag;
    if (shadowPrefix == null) {
      shadowPrefix = false;
    }
    tag = shadowPrefix ? "ui-" + this.tag : this.tag;
    return node.querySelectorAll(tag);
  };

  Component.createTemplateNodes = function() {
    return this.compiledTemplate.clone().children;
  };

  Component.define = function(component, prop, value) {
    Object.defineProperty(component, prop, {
      value: value,
      writable: false,
      enumerable: false,
      configurable: true
    });
  };

  Component.init = function(host, app) {
    var children, component, scope, shadowRoot;
    children = this.createTemplateNodes();
    shadowRoot = host.createShadowRoot(this.id);
    shadowRoot.html(children);
    component = Object.create(this.prototype);
    scope = Object.create(ui.globals);
    this.define(component, 'host', host);
    this.define(component, 'scope', scope);
    this.define(component, 'app', app || component);
    host.component = component;
    component.constructor();
    this.tree.init(shadowRoot, component, scope);
    this.initedComponents.push(component);
    host.one('destroy', (function(_this) {
      return function() {
        var index;
        if (typeof component.destructor === "function") {
          component.destructor();
        }
        index = _this.initedComponents.indexOf(component);
        _this.initedComponents.splice(index, 1);
      };
    })(this));
    return component;
  };

  Component.reloadStyle = function() {
    this.compileStyle();
  };

  Component.reloadTemplate = function() {
    var children, component, host, i, len, ref, scope, shadowRoot;
    this.compileTemplate();
    ref = this.initedComponents.slice();
    for (i = 0, len = ref.length; i < len; i++) {
      component = ref[i];
      host = component.host;
      scope = component.scope;
      host.destroyShadowRoot();
      children = this.createTemplateNodes();
      shadowRoot = host.createShadowRoot(this.id);
      shadowRoot.html(children);
      this.tree.init(shadowRoot, component, scope);
    }
  };

  Component.reload = function() {
    var app, component, host, i, len, ref;
    this.compile();
    ref = this.initedComponents.slice();
    for (i = 0, len = ref.length; i < len; i++) {
      component = ref[i];
      host = component.host;
      app = component.app;
      host.destroy(false);
      host.destroyShadowRoot();
      this.init(host, app);
    }
  };

  Component.prototype.require = function(tag) {
    var context, match, optional, ref, ref1;
    match = tag.match(/(.+?)(\?)?$/);
    tag = match[1];
    optional = !!match[2];
    context = this.host.parent;
    while (context) {
      if (((ref = context.component) != null ? (ref1 = ref.constructor) != null ? ref1.tag : void 0 : void 0) === tag) {
        return context.component;
      }
      context = context.parent;
    }
    if (optional) {
      return null;
    }
    throw Error("Not found parent component '" + tag + "' for '" + this.constructor.tag + "'");
  };

  Component.prototype.emit = function(eventName, event) {
    this.host.emit(eventName, event);
  };

  Component.prototype.on = function(eventName, handler) {
    this.host.on(eventName, handler);
  };

  Component.prototype.one = function(eventName, handler) {
    this.host.one(eventName, handler);
  };

  Component.prototype.own = function(eventName, handler) {
    this.host.own(eventName, handler);
  };

  Component.prototype.off = function(eventName, handler) {
    this.host.off(eventName, handler);
  };

  Component.prototype.bindClass = function(className, exp) {
    return this.host.bindClass(className, exp, this, this.scope);
  };

  Component.prototype.bind = function(path, exp) {
    return ui.bind(this, path, this, exp, this.scope);
  };

  Component.prototype.watch = function(exp, handler, firstCall) {
    return ui.watch(this, exp, handler, null, firstCall);
  };

  return Component;

})();

//# sourceMappingURL=component.js.map
