{"version":3,"sources":["utils.es6"],"names":[],"mappings":";;;;;;;;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;;;;;;;;;IAGqB,K;;;;;;;wBAGP,Q,EAAU,M,EAAQ;AAC9B,UAAO,IAAI,OAAJ,CAAY,UAAU,OAAV,EAAmB,MAAnB,EAA2B;AAC7C,QAAI,CAAC,MAAL,EAAa,MAAM,KAAN;;AAEb,0BAAO,eAAK,OAAL,CAAa,QAAb,CAAP,EAA+B,UAAU,KAAV,EAAiB;AAC/C,SAAI,KAAJ,EAAW,OAAO,KAAP;AACX,SAAI,cAAc,aAAG,iBAAH,CAAqB,QAArB,CAAlB;AACA,YAAO,IAAP,CAAY,WAAZ;AACA,YAAO,EAAP,CAAU,KAAV,EAAiB,OAAjB;AACA,YAAO,EAAP,CAAU,OAAV,EAAmB,MAAnB;AACA,iBAAY,EAAZ,CAAe,OAAf,EAAwB,MAAxB;AACA,KAPD;AAQA,IAXM,CAAP;AAYA;;;;wEAGsB,O;;;;;yCACf,IAAI,OAAJ,CAAY,UAAU,OAAV,EAAmB,MAAnB,EAA2B;AAC7C,aAAI,CAAC,OAAL,EAAc,OAAO,SAAP;AACd,8BAAM,OAAN,EAAe,YAAY;AAC1B;AACA,UAFD;AAGA,SALM,C;;;;;;;;;;;;;;;;;;uCAS+B;AAAA,OAAb,MAAa,yDAAJ,EAAI;;AACtC,UAAO,iBAAO,WAAP,CAAmB,MAAnB,EAA2B,QAA3B,CAAoC,KAApC,CAAP;AACA;;;;yEAGqB,M,EAAQ,G;QAGzB,W,EACA,U,EACA,Q,EACA,Q,EACA,O;;;;;YANC,M;;;;;cAAc,K;;;AAEf,mB,GAAc,iBAAO,O;AACrB,kB,GAAa,KAAK,kBAAL,CAAwB,EAAxB,C;AACb,gB,GAAW,KAAK,kBAAL,CAAwB,CAAxB,WAAiC,GAAjC,C;AACX,gB,GAAW,eAAK,IAAL,CAAU,WAAV,EAAuB,UAAvB,EAAmC,QAAnC,C;AACX,e,GAAa,U,SAAc,Q;;eACzB,KAAK,KAAL,CAAW,QAAX,EAAqB,MAArB,C;;;0CACC,O;;;;;;;;;;;;;;;;;;;yEAIY,O;QAEf,W,EACA,O;;;;;YAFC,O;;;;;;;;AACD,mB,GAAc,iBAAO,O;AACrB,e,GAAU,eAAK,IAAL,CAAU,WAAV,EAAuB,eAAK,KAAL,CAAW,OAAX,EAAoB,GAA3C,C;;eACR,KAAK,SAAL,CAAe,OAAf,C;;;;;;;;;;;;;;;;;;8BAIY,M,EAAQ,G,EAAiC;AAAA,OAA5B,KAA4B,yDAApB,IAAoB;AAAA,OAAd,MAAc,yDAAL,IAAK;;AAC3D,UAAO,kBAAG,MAAH,WAAkB,GAAlB,EAAyB,MAAzB,CAAgC,KAAhC,EAAuC,MAAvC,EAA+C,GAA/C,EAAoD,MAApD,EAAP;AACA;;;;yEAGsB,M,EAAQ,G;QAAK,K,yDAAQ,I;QAAM,M,yDAAS,I;QACtD,Q;;;;;AAAA,gB,GAAW,KAAK,WAAL,CAAiB,MAAjB,EAAyB,GAAzB,EAA8B,KAA9B,EAAqC,MAArC,C;;eACF,KAAK,QAAL,CAAc,QAAd,EAAwB,GAAxB,C;;;;;;;;;;;;;;;;;;;;;;;;kBA9DM,K","file":"utils.js","sourcesContent":["import gm from 'gm'\r\nimport fs from 'fs'\r\nimport path from 'path'\r\nimport mkdirp from 'mkdirp'\r\nimport crypto from 'crypto'\r\nimport rmdir from 'rmdir'\r\nimport config from '../config'\r\n\r\n\r\nexport default class Utils {\r\n\r\n\r\n\tstatic _save(filepath, stream) {\r\n\t\treturn new Promise(function (resolve, reject) {\r\n\t\t\tif (!stream) throw Error `2 argument isnt stream`\r\n\r\n\t\t\tmkdirp(path.dirname(filepath), function (error) {\r\n\t\t\t\tif (error) reject(error)\r\n\t\t\t\tlet writeStream = fs.createWriteStream(filepath)\r\n\t\t\t\tstream.pipe(writeStream)\r\n\t\t\t\tstream.on('end', resolve)\r\n\t\t\t\tstream.on('error', reject)\r\n\t\t\t\twriteStream.on('error', reject)\r\n\t\t\t})\r\n\t\t})\r\n\t}\r\n\r\n\r\n\tstatic async removeDir(dirpath) {\r\n\t\treturn new Promise(function (resolve, reject) {\r\n\t\t\tif (!dirpath) return resolve()\r\n\t\t\trmdir(dirpath, function () {\r\n\t\t\t\tresolve()\r\n\t\t\t})\r\n\t\t})\r\n\t}\r\n\r\n\r\n\tstatic createRandomString(length = 64) {\r\n\t\treturn crypto.randomBytes(length).toString('hex')\r\n\t}\r\n\r\n\r\n\tstatic async saveFile(stream, ext) {\r\n\t\tif (!stream) throw Error `1 argument isnt stream`\r\n\r\n\t\tlet storagePath = config.storage\r\n\t\tlet folderName = this.createRandomString(64)\r\n\t\tlet fileName = this.createRandomString(5) + `.${ext}`\r\n\t\tlet filePath = path.join(storagePath, folderName, fileName)\r\n\t\tlet fileUrl = `${folderName}/${fileName}`\r\n\t\tawait this._save(filePath, stream)\r\n\t\treturn fileUrl\r\n\t}\r\n\r\n\r\n\tstatic async remove(fileUrl) {\r\n\t\tif (!fileUrl) return\r\n\t\tlet storagePath = config.storage\r\n\t\tlet dirPath = path.join(storagePath, path.parse(fileUrl).dir)\r\n\t\tawait this.removeDir(dirPath)\r\n\t}\r\n\r\n\r\n\tstatic resizeImage(stream, ext, width = 1024, height = 1024){\r\n\t\treturn gm(stream, `img.${ext}`).resize(width, height, '!').stream()\r\n\t}\r\n\r\n\r\n\tstatic async saveImage(stream, ext, width = 1024, height = 1024) {\r\n\t\tlet gmStream = this.resizeImage(stream, ext, width, height)\r\n\t\treturn await this.saveFile(gmStream, ext)\r\n\t}\r\n\r\n\r\n}\r\n\r\n\r\n"]}